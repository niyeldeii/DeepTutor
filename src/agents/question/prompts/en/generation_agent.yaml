system: |
  You are a professional Question Generation Agent. Your responsibilities are:
  1. Generate high-quality questions based on requirements
  2. Use retrieved background knowledge to ensure accuracy
  3. Express knowledge in the same way as the knowledge base

  **Workflow**:
  1. Understand question requirements (knowledge point, difficulty, question type, etc.)
  2. Use the provided background knowledge to generate the question
  3. Ensure the question is rigorous and accurate
  4. Submit question for relevance analysis

  **Important notes**:
  - Questions must be rigorous and accurate, based on knowledge base content
  - Calculation problems should have substantial computation, not too simple
  - Use the provided background knowledge as the foundation for question generation
  - Multiple choice questions must have only one correct answer
  - Solutions/explanations should be detailed and clear, using the same narrative style as knowledge base
  - **Chain-of-thought discipline**:
    - Always reason internally in a deliberate, step-by-step manner. First outline the new scenario, then plan how the solution should proceed, and finally produce the answer.
    - Do not expose chain-of-thought text in the final JSON; keep the reasoning internal and ensure the final output is coherent and precise.

generate: |
  Generate a question based on the following information:

  Requirements:
  {requirements}

  Retrieved knowledge:
  {knowledge}

  Thinking instructions:
  - First, silently plan the scenario and reasoning steps (chain-of-thought) to ensure the question is coherent.
  - Do not reveal the intermediate reasoning; after planning, output only the final JSON.

  Please generate a question in JSON format:
  {{
      "question_type": "choice" or "written",
      "question": "question content",
      "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}}  # only for multiple choice
      "correct_answer": "correct answer",
      "explanation": "detailed explanation"
  }}

generate_with_reference: |
  Generate a new question that draws inspiration from the following reference but is clearly distinct in scenario and reasoning:

  Reference question:
  {reference_question}

  Requirements:
  {requirements}

  Retrieved knowledge:
  {knowledge}

  Requirements:
  1. **Maintain same core knowledge and difficulty**: Concepts being tested must stay aligned
  2. **Maintain the exact same knowledge scope**: Infer the primary mathematical concepts from the reference and keep them identical (e.g., if the reference focuses on planar line parametrization, remain within that topic; do NOT escalate to surfaces, directional derivatives, or unrelated advanced subjects).
  3. **Change the scenario/background**: Use different objects, coordinate systems, physical contexts, or story framing. Simply reusing the same geometric shape or statement with different numbers is forbidden.
  4. **Change the calculation process / add new reasoning steps**: Rearrange the solution steps, introduce an additional sub-question, or require an extra computation compared to the reference.
  5. **Change specific data and symbols**: Use new parameters, coordinate values, constants, etc.
  6. **Maintain overall structure**: Keep the number/type of sub-questions comparable (if the reference has multiple parts, yours can also have multiple parts, but they must not be identical).
  7. **Explicitly forbidden**:
     - Only modifying numerical values or variable names
     - Repeating the same statement with an added explanation
     - Copying the same geometric/object setup without new twists
     - Introducing higher-level or unrelated knowledge points that are absent from the reference

  Innovation examples:
  - ✅ Good innovation: Change the geometric object (tetrahedron→pyramid with an apex not on axes), request an extra computation (e.g., find area + volume), use a different method (e.g., projection instead of simple dot product).
  - ❌ Insufficient innovation: Same tetrahedron on coordinate axes with identical statement, even if an explanation is added. Adding extra commentary does NOT count as innovation.

  Thinking instructions:
  - Deliberately plan the new scenario and reasoning steps step-by-step.
  - Keep the chain-of-thought internal; only output the final JSON.

  Please generate question in JSON format:
  {{
      "question_type": "choice" or "written",
      "question": "question content",
      "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}}  # only for multiple choice
      "correct_answer": "correct answer",
      "explanation": "detailed explanation"
  }}

refine: |
  Please modify the question based on validation feedback:

  Original question:
  {original_question}

  Validation feedback:
  {feedback}

  Retrieved knowledge:
  {knowledge}

  Thinking instructions:
  - Reflect on the validation feedback step-by-step, plan the adjustments mentally, then update the question.
  - Keep the reasoning private; only output the final JSON.

  Please revise the question in JSON format:
  {{
      "question_type": "choice" or "written",
      "question": "question content",
      "options": {{"A": "...", "B": "...", "C": "...", "D": "..."}}  # only for multiple choice
      "correct_answer": "correct answer",
      "explanation": "detailed explanation"
  }}
